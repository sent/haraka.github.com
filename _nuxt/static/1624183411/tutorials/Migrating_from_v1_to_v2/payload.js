__NUXT_JSONP__("/tutorials/Migrating_from_v1_to_v2", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B){return {data:[{document:{slug:"Migrating_from_v1_to_v2",title:"Migrating from Haraka v1.x to v2.x",position:18,category:"Tutorials",toc:[{id:s,depth:l,text:t},{id:u,depth:l,text:v},{id:w,depth:l,text:x}],body:{type:"root",children:[{type:b,tag:e,props:{},children:[{type:a,value:"Haraka v2.x contains two significant changes to the v1.x API related to\nstreams."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Streams are an abstraction over a data flow that is provided by Node core\nand is used throughout node to \"pipe\" data between two places or more. This\nmakes programming very easy, and is hence why we started using them in Haraka\nstarting with version 2.0.0."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"For more information about the Stream API, see\n"},{type:b,tag:k,props:{href:y,rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:a,value:y}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"It's important to note that if you are using standard Haraka plugins then\nit's very unlikely you will need to change anything. Though you may want\nto configure "},{type:b,tag:d,props:{},children:[{type:a,value:"spool_dir"}]},{type:a,value:" and "},{type:b,tag:d,props:{},children:[{type:a,value:"spool_after"}]},{type:a,value:" in "},{type:b,tag:d,props:{},children:[{type:a,value:"config\u002Fsmtp.ini"}]},{type:a,value:". However if\nyou have written custom plugins, continue reading."}]},{type:a,value:c},{type:b,tag:m,props:{id:s},children:[{type:b,tag:k,props:{href:"#changes-to-look-for",ariaHidden:n,tabIndex:o},children:[{type:b,tag:p,props:{className:[q,r]},children:[]}]},{type:a,value:t}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Firstly, the incoming data in an email (the email body) is now stored in an\nobject which you can treat as a ReadableStream. To find if this is relevant\nfor you, look for instances of "},{type:b,tag:d,props:{},children:[{type:a,value:"data_lines"}]},{type:a,value:z}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Secondly, if you parse the mail body, attachments are now provided as a\nstream, rather than custom start\u002Fdata\u002Fend events. To find if this is relevant\nfor you, look for instances of "},{type:b,tag:d,props:{},children:[{type:a,value:"attachment_hooks"}]},{type:a,value:z}]},{type:a,value:c},{type:b,tag:m,props:{id:u},children:[{type:b,tag:k,props:{href:"#fixing-data_lines-plugins",ariaHidden:n,tabIndex:o},children:[{type:b,tag:p,props:{className:[q,r]},children:[]}]},{type:a,value:v}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Any plugins now working on each line of data will need to change to using a\nstream. The stream is called "},{type:b,tag:d,props:{},children:[{type:a,value:"transaction.message_stream"}]},{type:a,value:A}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"These changes may be complicated if you are iterating over each line and\ndoing something with the strings therein. However if you are piping the data\nto an application or over a network, your code will become significantly\nsimpler (and a lot faster)."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"In v1.x Haraka populated the "},{type:b,tag:d,props:{},children:[{type:a,value:"transaction.data_lines"}]},{type:a,value:" array for each line of\ndata received.  If you were writing the data to a socket then you had to handle backpressure manually by checking the return of "},{type:b,tag:d,props:{},children:[{type:a,value:"write()"}]},{type:a,value:" and adding\n"},{type:b,tag:d,props:{},children:[{type:a,value:"on('drain')"}]},{type:a,value:" handlers like so:"}]},{type:a,value:c},{type:b,tag:f,props:{className:[g]},children:[{type:b,tag:h,props:{className:[i,j]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"var data_marker = 0;\nvar in_data = false;\nvar end_pending = true;\nvar send_data = function () {\n    in_data = true;\n    var wrote_all = true;\n    while (wrote_all && (data_marker \u003C connection.transaction.data_lines.length)) {\n        var line = connection.transaction.data_lines[data_marker];\n        data_marker++;\n        wrote_all = socket.write(Buffer.from(line.replace(\u002F^\\.\u002F, '..').replace(\u002F\\r?\\n\u002Fg, '\\r\\n')), 'binary');\n        if (!wrote_all) return;\n    }\n    \u002F\u002F we get here if wrote_all still true, and we got to end of data_lines\n    if (end_pending) {\n        end_pending = false;\n        \u002F\u002F Finished...\n        socket.send_command('dot');\n    }\n};\nsocket.on('drain', function () {\n    if (end_pending && in_data) {\n        setImmediate(function () { send_data() });\n    }\n});\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"In v2.x this now becomes:"}]},{type:a,value:c},{type:b,tag:f,props:{className:[g]},children:[{type:b,tag:h,props:{className:[i,j]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"connection.transaction.message_stream.pipe(socket, {dot_stuffing: true, ending_dot: true});\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"This automatically chunks the data, handles backpressure and will apply any\nnecessary format changes.  See "},{type:b,tag:d,props:{},children:[{type:a,value:"docs\u002FTransaction.md"}]},{type:a,value:" for the full details."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"If you need to handle the input data by line, then you will need to create\nyour own writable stream and then pipe the message to the stream and then\nextract the lines from the stream of data.  See "},{type:b,tag:d,props:{},children:[{type:a,value:"plugins\u002Fdkim_sign.js"}]},{type:a,value:" for\nan example."}]},{type:a,value:c},{type:b,tag:m,props:{id:w},children:[{type:b,tag:k,props:{href:"#fixing-attachment_hooks-plugins",ariaHidden:n,tabIndex:o},children:[{type:b,tag:p,props:{className:[q,r]},children:[]}]},{type:a,value:x}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"For v1.x you passed in functions to "},{type:b,tag:d,props:{},children:[{type:a,value:"transaction.attachment_hooks()"}]},{type:a,value:" as\nfollows:"}]},{type:a,value:c},{type:b,tag:f,props:{className:[g]},children:[{type:b,tag:h,props:{className:[i,j]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"transaction.attachment_hooks(\n    function (ctype, filename, body) {...}, \u002F\u002F start\n    function (buf) {...}, \u002F\u002F data\n    function () {...} \u002F\u002F end\n);\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"That has now changed to:"}]},{type:a,value:c},{type:b,tag:f,props:{className:[g]},children:[{type:b,tag:h,props:{className:[i,j]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"transaction.attachment_hooks(\n    function (ctype, filename, body, stream) {...}, \u002F\u002F start\n);\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"This allows you to attach the stream to other streams via "},{type:b,tag:d,props:{},children:[{type:a,value:"stream.pipe(dest)"}]},{type:a,value:A}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Sometimes destination streams will apply backpressure on the sending stream,\nfor example if you are sending attachments to a remote service. In order\nfor this backpressure to apply to the connection itself (so that we don't\nhave to buffer up data in memory), we need to provide the connection object\nto the stream:"}]},{type:a,value:c},{type:b,tag:f,props:{className:[g]},children:[{type:b,tag:h,props:{className:[i,j]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"var transaction = connection.transaction;\ntransaction.attachment_hooks(\n    function (ctype, filename, body, stream) {\n        stream.connection = connection;\n        ...\n    }\n);\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"For a full example of using attachment streams, see the Transaction.md\ndocumentation file."}]}]},dir:"\u002Fen\u002Ftutorials",path:"\u002Fen\u002Ftutorials\u002FMigrating_from_v1_to_v2",extension:".md",createdAt:B,updatedAt:B,to:"\u002Ftutorials\u002FMigrating_from_v1_to_v2"},prev:{slug:"Plugins",title:"Haraka Plugins",to:"\u002Ftutorials\u002FPlugins"},next:{slug:"SettingUpOutbound",title:"Configuring Haraka For Outbound Email",to:"\u002Ftutorials\u002FSettingUpOutbound"}}],fetch:[],mutations:[]}}("text","element","\n","code","p","div","nuxt-content-highlight","pre","language-text","line-numbers","a",2,"h2","true",-1,"span","icon","icon-link","changes-to-look-for","Changes To Look For","fixing-data_lines-plugins","Fixing data_lines plugins","fixing-attachment_hooks-plugins","Fixing attachment_hooks plugins","http:\u002F\u002Fnodejs.org\u002Fapi\u002Fstream.html"," in your plugins.",".","2021-06-20T10:01:43.413Z")));